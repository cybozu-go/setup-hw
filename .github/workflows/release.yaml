name: Release
on:
  pull_request:
  workflow_run:
    workflows:
      - 'Main'
    tags:
      - 'v*'
    types:
      - completed
      - requested
jobs:
  push-image:
    name: push-image
    runs-on: ubuntu-20.04
    steps:
      - name: Load images
        uses: actions/download-artifact@v2
        with:
          name: setup-hw-images
      - name: Push Images to Quay.io
        env:
          QUAY_USER: ${{ secrets.QUAY_USER }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          docker login -u $QUAY_USER -p $QUAY_PASSWORD quay.io
          TAG=${GITHUB_REF#refs/*/}
          for name in setup-hw setup-hw-secret; do
              echo "pushing ${name} ..."
              docker tag quay.io/cybozu/${name}:latest quay.io/cybozu/${name}:$TAG
              docker push quay.io/cybozu/${name}:latest
              docker push quay.io/cybozu/${name}:$TAG
          done
